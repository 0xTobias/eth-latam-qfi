# Values for the current status/stage of the QFI.
enum Stage {
  NotInitialized
  WaitingForSignupsAndTopups
  VotingPeriodOpen
  WaitingForFinalization
  Finalized
  Cancelled
}

# Values for the RecipientRegistry requests.
enum RequestType {
  Registration
  Removal
}

# QFI Core entity.
type QFI @entity {
    id: ID!

    # Main fields.
    coordinator: Coordinator
    currentStage: Stage! # Enum.
    voiceCreditFactor: BigInt!
    nextGrantRoundId: BigInt!
    contributorCount: BigInt!
    isStateAqMerged: Boolean

    # Inherited from MACI.
    stateTreeDepth: Int
    numSignUps: BigInt!
    isInitialized: Boolean
    signUpTimestamp: BigInt!
    # Useful smart contracts addresses.
    signUpGatekeeperAddress: Bytes!
    initialVoiceCreditProxyAddress: Bytes!
    vkRegistryAddress: Bytes
    pollFactoryAddress: Bytes!
    messageAqFactoryPollAddress: Bytes
    stateAqAddress: Bytes
    nativeERC20TokenAddress: Bytes!
    messageAqFactoryGrantRoundAddress: Bytes
    grantRoundFactoryAddress: Bytes!
    pollProcessorAndTallyerAddress: Bytes

    # Links.
    recipientRegistry: RecipientRegistry
    currentGrantRound: GrantRound

    # Reverse Lookups.
    grantRounds: [GrantRound!] @derivedFrom(field: "qfi")
    # Specifically, those Polls are GrantRounds (polls[pollId] = g, where g is a GrantRound).
    polls: [GrantRound!] @derivedFrom(field: "qfi")
    
    fundingSources: [FundingSource!] @derivedFrom(field: "qfi")

    createdAt: String!
    lastUpdatedAt: String!
}

# Represents a PublicKey used during the subscription/forwarding of a message. 
type PublicKey @entity {
    id: ID!

    # Main fields.
    x: BigInt!
    y: BigInt!

    # Associated voting info.
    stateIndex: BigInt
    voiceCreditBalance: BigInt
    
    # Links.
    grantRound: GrantRound # Can be present if the PublicKey is used in addition to send a message.

    # Reverse Lookup for the messages signed w/ this public key.
    messages: [Message!] @derivedFrom(field: "publicKey")

    timestamp: String!
}

# A message sent from a public key by a voter.
type Message @entity {
    id: ID!
    
    data: [BigInt!]!

    # Links.
    publicKey: PublicKey!
    grantRound: GrantRound!
    
    timestamp: String!
}

# The registry where the recipient for the GrantRound are recorded
# (nb. Mainly based on OptimisticRecipientRegistry implementation.)
type RecipientRegistry @entity {
    id: ID!

    # Main fields.
    grantRoundFactoryAddress: Bytes!
    baseDeposit: BigInt!
    challengePeriodDuration: BigInt!
    controller: Bytes!
    maxRecipients: BigInt!

    # Link.
    grantRound: GrantRound!

    # Reverse Lookup for the recipients registered in this registry.
    recipients: [Recipient!] @derivedFrom(field: "recipientRegistry")

    createdAt: String!
    lastUpdatedAt: String!
}

# Represent a Recipient for the GrantRound w/ requests info for add/remove.
# (nb. Mainly based on OptimisticRecipientRegistry implementation.)
type Recipient @entity {
    id: ID!

    # Main fields.
    address: Bytes!
    metadata: String
    requestType: RequestType # Enum.
    requesterAddress: Bytes
    submissionTime: BigInt
    deposit: BigInt
    addedAt: BigInt
    removedAt: BigInt
    voteOptionIndex: BigInt
    rejected: Boolean!
    # Tx hash mirror.
    requestResolvedHash: Bytes
    requestSubmittedHash: Bytes

    # Links.
    grantRounds: [GrantRoundRecipient!] @derivedFrom(field: "recipient")
    recipientRegistry: RecipientRegistry!

    # Reverse Lookup of the claimed funds sent to this recipient.
    funds: [Funds!] @derivedFrom(field: "recipient")

    createdAt: String!
    lastUpdatedAt: String!
}

# Mapping table to handle efficiently the GrantRound-Recipient many-to-many relationship.
type GrantRoundRecipient @entity {
  id: ID! # Set to `${grantRound.id}-${recipient.id}`

  grantRound: GrantRound!
  recipient: Recipient!
}

type GrantRound @entity {
    id: ID!

    # Main fields (also from Poll).
    # Max values.
    maxMessages: BigInt!
    maxVoteOptions: BigInt!
    # Tree depths.
    intStateTreeDepth: BigInt!
    messageTreeSubDepth: BigInt!
    messageTreeDepth: BigInt!
    voteOptionTreeDepth: BigInt!
    # Batch sizes.
    tallyBatchSize: BigInt!
    messageBatchSize: BigInt!
    # Time and duration.
    duration: BigInt!
    deployTimestamp: BigInt! # Grant Round start time.
    voiceCreditFactor: BigInt!
    # Status.
    isCancelled: Boolean
    isMessageAqMerged: Boolean
    isFinalized: Boolean
    stateAqMerged: Boolean
    # State Ballot commitment.
    mergedStateRoot: BigInt
    tallyHash: String
    # Total amounts spent, votes, and matching funds.
    totalSpent: BigInt
    totalVotes: BigInt
    matchingPoolSize: BigInt

    # Links.
    qfi: QFI!
    recipientRegistry: RecipientRegistry!
    coordinator: Coordinator!

    # Reverse Lookups.
    # Messages related to this grant round.
    messages: [Message!] @derivedFrom(field: "grantRound")
    # Recipients related to this grant round.
    recipients: [GrantRoundRecipient!] @derivedFrom(field: "grantRound")
    # Who has contributed to the grant round.
    contributors: [GrantRoundContributor!] @derivedFrom(field: "grantRound")
    # The contributions to the grant round.
    contributions: [Contribution!] @derivedFrom(field: "grantRound")
    # Who has quadratically voted (w/ VCs) in the grant round.
    votes: [Vote!] @derivedFrom(field: "grantRound")
    
    createdAt: String!
    lastUpdatedAt: String!
}

# MACI/QFI Coordinator.
type Coordinator @entity {
    id: ID!

    # Main fields.
    address: Bytes!
    publicKey: String!

    # Links.
    qfi: QFI!
    grantRounds: [GrantRound!] @derivedFrom(field: "coordinator")

    timestamp: String!
}

# A contributor who has sent tokens to the matching pool in exchange of VCs.
type Contributor @entity {
    id: ID!
    
    # Main fields.
    address: Bytes! # Eth EOA.
    voiceCredits: BigInt!
    isRegistered: Boolean!

    # Link.
    grantRounds: [GrantRoundContributor!] @derivedFrom(field: "contributor")

    # Reverse lookups.
    contributions: [Contribution!] @derivedFrom(field: "contributor")
    votes: [Vote!] @derivedFrom(field: "contributor")
    
    createdAt: String!
    lastUpdatedAt: String!
}

# Mapping table to handle efficiently the GrantRound-Contributor many-to-many relationship.
type GrantRoundContributor @entity {
  id: ID! # Set to `${grantRound.id}-${contributor.id}`

  grantRound: GrantRound!
  contributor: Contributor!
}

type Contribution @entity {
    id: ID!

    # Main fields.
    amount: BigInt!
    voiceCredits: BigInt!

    # Links.
    contributor: Contributor!
    grantRound: GrantRound!

    createdAt: String!
    lastUpdatedAt: String!
}

# An amount of funds claimed/donated.
type Funds @entity {
    id: ID!

    # Main fields.
    amount: BigInt!
    voteOptionIndex: BigInt!

    # Links
    recipient: Recipient!
    grantRound: GrantRound!

    createdAt: String!
}

# This entity is stored when a contributor cast a vote (publish a message).
type Vote @entity {
    id: ID!

    # Links.
    contributor: Contributor!
    grantRound: GrantRound!
}

# Represent a funding source to the match poll for a Grant Round.
type FundingSource @entity {
    id: ID!

    qfi: QFI!
    address: Bytes!
    isActive: Boolean! # False when removed, otherwise true.

    createdAt: String!
    lastUpdatedAt: String!
}